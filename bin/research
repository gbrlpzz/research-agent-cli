#!/bin/bash
# Research CLI - paper discovery and citation management

REPO_ROOT="$HOME/Documents/GitHub/research-agent-cli"
VENV="$REPO_ROOT/.venv"
PYTHON="$VENV/bin/python"

# Show usage if no args
if [ -z "$1" ]; then
    echo "Usage:"
    echo "  research <query>              Unified multi-source search (S2 + paper-scraper)"
    echo "  research agent <topic>        Autonomous research agent (produces Typst docs)"
    echo "  research agent resume [path]  Resume interrupted session (auto-detects latest)"
    echo "  research exa <query>          Semantic search with Exa.ai (costs credits)"
    echo "  research edison <query>       AI literature synthesis (costs 1 credit)"
    echo "  research edison list          Browse past Edison reports"
    echo "  research edison show <id>     View specific report"
    echo "  research edison cache <query> Check if query cached"
    echo "  research edison credits       Show credit balance"
    echo "  research add [id]             Quick add from DOI/arXiv (or clipboard)"
    echo "  research cite [query]         Search library and copy citation keys"
    echo "  research open [query]         Search library and open paper in browser"
    echo "  research qa <question>        Ask questions about your library (PaperQA RAG)"
    echo "  research bot                   Start the Telegram bot"
    echo "  research help                 Show interactive tutorial with examples"
    echo ""
    echo "Examples:"
    echo "  research \"attention mechanism\"         # Find papers about attention"
    echo "  research agent \"impact of transformers\" # Full research report"
    echo "  research agent resume                   # Resume last interrupted session"
    echo "  research exa \"reasoning in LLMs\"       # Semantic search with Exa.ai"
    echo "  research edison \"few-shot learning\"   # AI synthesis (1 credit)"
    echo "  research add 10.1234/example           # Add paper by DOI"
    echo "  research cite egger                    # Find citations by Egger"
    echo "  research help                          # Interactive tutorial"
    exit 0
fi


# Handle subcommands
case "$1" in
    edison)
        shift
        # Check if first arg is a subcommand or a query
        if [ -z "$1" ]; then
            echo "Usage: research edison <query|list|show|cache|credits>"
            exit 1
        fi
        
        # Check if it's a subcommand (starts with no quotes, matches known commands)
        case "$1" in
            list)
                "$PYTHON" "$REPO_ROOT/scripts/edison_literature.py" --list
                ;;
            show)
                shift
                "$PYTHON" "$REPO_ROOT/scripts/edison_literature.py" --show "$@"
                ;;
            cache)
                shift
                "$PYTHON" "$REPO_ROOT/scripts/edison_literature.py" --cache "$@"
                ;;
            credits)
                "$PYTHON" "$REPO_ROOT/scripts/edison_literature.py" --credits
                ;;
            *)
                # Default: treat as query
                "$PYTHON" "$REPO_ROOT/scripts/edison_literature.py" "$@"
                ;;
        esac
        ;;
    exa)
        shift
        "$PYTHON" "$REPO_ROOT/scripts/exa_search.py" "$@"
        ;;
    agent)
        shift
        # Check for 'resume' subcommand (research agent resume)
        if [ "$1" = "resume" ]; then
            shift
            # If a specific path is provided, use it
            if [ -n "$1" ]; then
                "$PYTHON" "$REPO_ROOT/scripts/agent.py" --resume "$1"
            else
                # Auto-detect: find the most recent interrupted session
                # An interrupted session has checkpoint.json but no main.pdf
                LATEST_INTERRUPTED=""
                for dir in $(ls -dt "$REPO_ROOT/reports"/20* 2>/dev/null); do
                    if [ -f "$dir/artifacts/checkpoint.json" ] && [ ! -f "$dir/main.pdf" ]; then
                        LATEST_INTERRUPTED="$dir"
                        break
                    fi
                done
                
                if [ -z "$LATEST_INTERRUPTED" ]; then
                    echo "No interrupted sessions found."
                    echo ""
                    echo "An interrupted session is a report directory with:"
                    echo "  - artifacts/checkpoint.json (progress saved)"
                    echo "  - No main.pdf (not completed)"
                    echo ""
                    echo "To resume a specific session:"
                    echo "  research agent resume reports/20251212_150513_..."
                    exit 1
                fi
                
                echo "Found interrupted session: $(basename "$LATEST_INTERRUPTED")"
                echo ""
                "$PYTHON" "$REPO_ROOT/scripts/agent.py" --resume "$LATEST_INTERRUPTED"
            fi
        else
            "$PYTHON" "$REPO_ROOT/scripts/agent.py" "$@"
        fi
        ;;
    add)
        shift
        "$PYTHON" "$REPO_ROOT/scripts/add.py" "$@"
        ;;
    cite)
        shift
        "$PYTHON" "$REPO_ROOT/scripts/cite.py" "$@"
        ;;
    open)
        shift
        "$PYTHON" "$REPO_ROOT/scripts/open.py" "$@"
        ;;
    qa)
        shift
        "$PYTHON" "$REPO_ROOT/scripts/qa.py" "$@"
        ;;
    help|--help|-h)
        "$PYTHON" "$REPO_ROOT/scripts/help.py"
        ;;
    bot)
        BOT_DIR="$REPO_ROOT/research-agent-telegram-bot"
        if [ ! -f "$BOT_DIR/bot.js" ]; then
            echo "Error: Telegram bot not found at $BOT_DIR"
            exit 1
        fi
        if [ ! -f "$BOT_DIR/.env" ]; then
            echo "Error: Bot .env file not found. Copy .env.example to .env and add your TELEGRAM_BOT_TOKEN"
            exit 1
        fi
        echo "Starting Telegram bot..."
        cd "$BOT_DIR" && npm start
        ;;
    *)
        # Default: search papers
        "$PYTHON" "$REPO_ROOT/scripts/discover.py" "$@"
        ;;
esac
